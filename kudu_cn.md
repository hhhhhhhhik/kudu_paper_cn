# Kudu:一种面向快速分析的数据存储引擎

## 摘要
&emsp;&emsp;Kudu是一款同时支持低延迟随机访问和高效数据分析两种模式的开源结构化存储引擎。Kudu以水平划分的方式将数据进行划分，每个数据片都有副本，并使用raft协议保证数据一致性，提供较低的数据恢复时间和尾延迟。Kudu的设计可无缝搭配Hadoop生态系统，提供对Cloudera Impala，Apache Spark和MapReduce等工具和编程模型的广泛支持。

## 1. 介绍
&emsp;&emsp;最近几年，各大企业产生和抓取的数据成爆炸性的增长，促进了低成本，大规模处理海量数据的相关开源技术蓬勃发展。这其中，Hadoop生态圈成为了“大数据”圈内关注的焦点，而传统开源数据库系统则因为无法提供如此大规模的集群式处理而渐渐落后。
&emsp;&emsp;通常，存储在Hadoop系统内的结构化数据有以下俩种方式：对于静态数据集，通常直接以二进制数据方式直接存储在HDFS上，比如Apache Avro和Apache Parquet。但是，无论是HDFS还是以上这些存储格式，都无法提供数据在单行级别的更新和数据高效的随机访问。而对于可变数据集，通常存储在Apache HBase，Apache Cassandra这类的半结构化存储引擎之上。这样的系统，可提供低延迟的行级的数据读取和写入，但是在处理类似基于SQL分析和机器学习的应用时，往往在顺序读取的吞吐量上远落后于以静态文件存储的方式。
&emsp;&emsp;拥有较强分析性能的HDFS存储静态数据集和拥有低延迟行级随机访问能力的HBase，Cassandra之间的区别和差距，造成了在同一个应用中，开发人员需要设计开发复杂的架构来同时处理这两类问题。特别对于很多Cloudera的用户来说，他们已经设计开发出来这样一套系统，可以通过接入流式数据，集成到HBase中进行实时更新，后续通过一系列的定时作业将这些HBase中的数据表数据导出成Parquet格式用于后续的分析。这样的架构有着以下几方面的不足：
&emsp;&emsp;1. 应用层必须通过复杂的代码对数据流和两个系统之间的数据同步进行管理。
&emsp;&emsp;2. 运维人员需要维护和管理一致的数据备份，安全策略，并监控多个不同的系统的状态。
&emsp;&emsp;3. 这样的架构必然会导致数据写入到HBase“中转区域”和数据能够被分析之间的巨大的时间延迟。
&emsp;&emsp;4. 实际环境中，系统通常需要处理迟来的数据，过往记录的修改和基于某些策略的数据删除，而这些数据已经被导出成为不可更改的数据存储根式。为了完成这些操作，会造成大量的数据重写，分区交换甚至人工干预。
&emsp;&emsp;Kudu是一种新的存储系统，它设计并实现来用于提供类似于HDFS的存储系统的高吞吐的顺序访问效率，同时又能提供类似于HBase和Cassandra这类系统低延迟的随机访问能力。尽管这些系统在特定的场景下仍然拥有自己的优势，但Kudu提供了一种“折中”的方式，能显著的简化一些常用系统的开发。另外，Kudu提供简单的行级别的API，包括插入，更新和删除，同时提供接近Parquet（一种被广泛使用的静态列式存储格式）的扫描吞吐性能。
&emsp;&emsp;本文将主要介绍Kudu的体系架构。第二章主要从用户视角介绍系统的数据模型，APIs和一些操作视角的结构。第三章主要介绍Kudu的架构，包括如何在多个节点之间进行数据划分和复制，如何在错误情况下进行数据恢复，如何进行常规的数据操作。第四章主要介绍Kudu为了达到同时保证快速随机访问和高效分析性能，是如何在磁盘上组织数据存储的。第五章主要讨论Kudu和其它Hadoop生态组件的集成。第六章主要提供在综合场景下初步的性能指标结果。

## 2. Kudu概览
### 2.1 表和表结构
### 2.2 写操作
### 2.3 读操作
### 2.4 其它API
### 2.5 一致性模型
### 2.6 时间戳

## 3. 架构
### 3.1 集群角色
### 3.2 数据划分
### 3.3 副本机制
#### 3.3.1 配置改变
### 3.4 Kudu Master节点
#### 3.4.1 元信息管理
#### 3.4.2 集群协调
#### 3.4.3 tablet目录

## 4. Tablet存储
### 4.1 总括
### 4.2 RowSets
### 4.3 MemRowSet实现
### 4.4 DiskRowSet实现
### 4.5 增量Flushes
### 4.6 插入流程
### 4.7 读取流程
### 4.8 延迟物化
### 4.9 增量合并
### 4.10 RowSet合并
### 4.11 维护调度

## 5. Hadoop集成
### 5.1 MapReduce和Spark
### 5.2 Impala

## 6. 性能评价
### 6.1 对比Parquet
### 6.2 对比Phoenix
### 6.3 随机访问性能

## 7. 总结

## 8. 参考文献
